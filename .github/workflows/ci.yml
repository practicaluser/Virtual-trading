# .github/workflows/ci.yml

name: Virtual Trading CI

on:
  push:
    branches: ['main']
    # backend, frontend ë˜ëŠ” ì›Œí¬í”Œë¡œìš° íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'backend/**'
      - 'frontend-vite/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: ['main']
    # backend, frontend ë˜ëŠ” ì›Œí¬í”Œë¡œìš° íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'backend/**'
      - 'frontend-vite/**'
      - '.github/workflows/ci.yml'

jobs:
  # Job 1: ë°±ì—”ë“œ ê²€ì¦
  backend-check:
    name: âœ… Backend Check
    runs-on: ubuntu-latest

    services:
      # í…ŒìŠ¤íŠ¸ìš© PostgreSQL ì„œë¹„ìŠ¤
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: stocksim_db
          POSTGRES_USER: stocksim_user
          POSTGRES_PASSWORD: stocksim_password
        ports:
          - 8765:5432 # Runnerì˜ 8765 í¬íŠ¸ì™€ ë§¤í•‘
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # [ê°œì„ ] Celery í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ Redis ì„œë¹„ìŠ¤ ì¶”ê°€
      redis:
        image: redis:6-alpine
        ports:
          - 6379:6379 # Runnerì˜ 6379 í¬íŠ¸ì™€ ë§¤í•‘
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # [ê°œì„ ] pip ì˜ì¡´ì„± ìºì‹±
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y libpq-dev

      - name: Install dependencies
        # [ê°œì„ ] backend ë””ë ‰í† ë¦¬ì—ì„œ ëª…ë ¹ì–´ ì‹¤í–‰
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # [ê°œì„ ] ë¦°íŒ… ë° ì»¤ë²„ë¦¬ì§€ ë„êµ¬ ì„¤ì¹˜
          pip install flake8 black isort coverage

      - name: Lint with flake8, black, isort
        # [ê°œì„ ] backend ë””ë ‰í† ë¦¬ì—ì„œ ëª…ë ¹ì–´ ì‹¤í–‰
        working-directory: ./backend
        run: |
          echo "Running flake8..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          echo "Running black check..."
          black --check .
          echo "Running isort check..."
          isort --check .

      - name: Run Django unit tests with coverage
        # [ê°œS] backend ë””ë ‰í† ë¦¬ì—ì„œ ëª…ë ¹ì–´ ì‹¤í–‰
        working-directory: ./backend
        # [ê°œì„ ] í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ì— Redis ì¶”ê°€
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 8765
          DB_NAME: stocksim_db
          DB_USER: stocksim_user
          DB_PASSWORD: stocksim_password
          REDIS_HOST: 127.0.0.1 # ì„œë¹„ìŠ¤ í¬íŠ¸ ë§¤í•‘ ì‚¬ìš©
          REDIS_PORT: 6379
          # [ê°œì„ ] Celeryê°€ í…ŒìŠ¤íŠ¸ ì¤‘ ì¦‰ì‹œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì • (ê¶Œì¥)
          CELERY_TASK_ALWAYS_EAGER: 'True'
        run: |
          # [ê°œì„ ] coverageë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ 80% ë¯¸ë§Œ ì‹œ ì‹¤íŒ¨
          coverage run manage.py test
          coverage report -m --fail-under=80

  # Job 2: í”„ëŸ°íŠ¸ì—”ë“œ ê²€ì¦
  frontend-check:
    name: ğŸš€ Frontend Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend-vite/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend-vite
        run: npm ci

      - name: Lint with ESLint
        working-directory: ./frontend-vite
        # [ê°œì„ ] || trueë¥¼ ì œê±°í•˜ì—¬ ë¦°íŠ¸ ì˜¤ë¥˜ ì‹œ CI ì‹¤íŒ¨
        run: npm run lint

      # [ê°œì„ ] ìœ ë‹› í…ŒìŠ¤íŠ¸(npm test) ë° E2E í…ŒìŠ¤íŠ¸ëŠ” ìš”ì²­ì— ë”°ë¼ ìƒëµ

      - name: Test production build
        working-directory: ./frontend-vite
        run: npm run build

  # [ê°œì„ ] Job 3: ëª¨ë“  CI í†µê³¼ í™•ì¸
  ci-pipeline-success:
    name: ğŸ CI Pipeline Success
    runs-on: ubuntu-latest
    # [ê°œì„ ] backend-checkì™€ frontend-checkê°€ ëª¨ë‘ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨
    needs: [backend-check, frontend-check]
    steps:
      - name: Report success
        run: echo "âœ… All CI checks passed successfully."
